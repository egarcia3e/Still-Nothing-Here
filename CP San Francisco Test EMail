SELECT
	A.email_date
	,division
	,A.deal_key	
	,deal_permalink
	,n_imps
	,n_opens
	,COALESCE(n_clicks,0) n_clicks
	,COALESCE(n_orders,0) n_orders
	,COALESCE(Net_Revenue,0) Net_Revenue
		
FROM (SELECT dd.day_rw email_date
				,deal_key
				,sum(total_impressions) n_imps
				,sum(same_day_opens_cnt) n_opens
				,sum(same_day_clicks_cnt) n_clicks
			FROM user_groupondw.deal_impression_purchase dip
			INNER JOIN user_groupondw.dim_day dd on dd.day_key = dip.date_key
			WHERE deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
				AND deal_position <= 9
				AND email_date between '2014-08-01' and '2014-08-10'
			GROUP by 1,2) A

LEFT JOIN
			(SELECT				
				deal_key
				,cast(order_created_date at time zone 'America Central' as date) order_date
				,COUNT(order_id) n_orders
				,sum(booked_net_revenue_amount) net_revenue
			FROM dw.v_fact_collections
			WHERE deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
				AND order_date between '2014-08-01' and '2014-08-10'
			GROUP by 1,2) B		on B.deal_key = A.deal_key and B.order_date = A.email_date
LEFT JOIN
			(SELECT
			deal_key
			,deal_permalink
			,division
		FROM user_groupondw.agg_deal
		WHERE deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
		group by 1,2,3) D on D.deal_key = A.deal_key
			
			
			

