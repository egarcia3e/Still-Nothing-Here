/* sandbox.ss_expt_metrics_compare_test contains list of all experiments*/






/*How many people "viewed" the San Francisco gallery page by day?*/
SELECT distinct
	EVENT_DATE
	,COOKIE_B

	FROM user_groupondw.fact_clickstream fc
		INNER JOIN (
			SELECT distinct
			PAGE_KEY
			FROM user_groupondw.dim_page
			WHERE PAGE_NAME = '/browse/san-francisco') A on A.PAGE_KEY = fc.SOURCE_PAGE_KEY
	WHERE fc.event_date between '2014-08-11' and '2014-08-13'
	AND EVENT_TYPE_KEY = 2





SELECT
B.EVENT_DATE
,B.COOKIE_B
,B.DEAL_KEY
,B.n_deal_views
,B.n_deal_clicks
,COALESCE(A.n_orders,0) n_orders
,COALESCE(A.Gross_Revenue,0) Gross_Revenue
,COALESCE(A.Net_Revenue,0) Net_Revenue


FROM (


	/*What is the revenue associated with the deal (and count orders)*/	
	SELECT	
	ORDER_DATE
	,SFo.deal_key
	,COUNT (distinct SFo.order_id) n_orders
	,CAST(SUM(Net_Revenue) as dec(12,2)) Net_Revenue
	,CAST(SUM(Gross_Revenue) as dec(12,2)) Gross_Revenue
	FROM 
	sandbox.edit_SanFran_orders SFo
	WHERE
	SFo.deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
	AND ORDER_DATE between '2014-08-11' and '2014-08-21'
	GROUP by 1,2) A

FULL OUTER JOIN (


	/*How many people clicked on one of the test deals?*/
	SELECT	
	fc.EVENT_DATE
	,fc.COOKIE_B
	,fc.deal_key
	,COUNT (distinct fc.COOKIE_B) n_deal_clicks
	FROM user_groupondw.fact_clickstream fc
	WHERE
	fc.deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
	AND fc.event_date between '2014-08-11' and '2014-08-21'
	AND fc.EVENT_TYPE_KEY = 1
	GROUP by 1,2,3) B on B.EVENT_DATE = A.ORDER_DATE AND B.deal_key = A.deal_key

	
FULL OUTER JOIN (


	/*How many people viewed on one of the test deals?*/
	SELECT	
	fc.EVENT_DATE
	,fc.COOKIE_B
	,fc.deal_key
	,COUNT (distinct fc.COOKIE_B) n_deal_views
	FROM user_groupondw.fact_clickstream fc
	WHERE
	fc.deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
	AND fc.event_date between '2014-08-11' and '2014-08-21'
	AND fc.EVENT_TYPE_KEY = 2
	GROUP by 1,2,3) D on D.EVENT_DATE = B.EVENT_DATE AND D.deal_key = B.deal_key
	
	
	/*Calculate revenue by deal by order_id*/
/*
drop table sandbox.edit_SanFran_orders

CREATE set table sandbox.edit_SanFran_orders as (
SELECT
vfc.deal_key
,CAST(vfc.order_created_date at time zone 'America Central' as date) ORDER_DATE
,vfc.order_date_key
,vfc.order_id
,SUM(vfc.booked_net_revenue_amount) Net_Revenue
,SUM(vfc.booking_amount) Gross_Revenue
FROM dw.v_fact_collections vfc
WHERE vfc.deal_key in (3191304,3189561,3188813,3188804,3186361,3186249,3180999,3174899,3174164,3170227,3162903,3162734,3156368,3147874,3147873,3142061,3137965,3137013,3134028,3133840)
GROUP by 1,2,3,4
)with data primary index(deal_key), index(order_id);
*/ 










 
SELECT top 20
o.opportunity_id
,ad.deal_key

FROM user_groupondw.dim_opportunity o
INNER JOIN user_groupondw.agg_deal ad on ad.opportunity_key = o.opportunity_key

WHERE
o.opportunity_id IN (
'006C000000pGR2G'
,'006C000000ny1QA'
,'006C000000pGzQQ'
,'006C000000pHVia'
,'006C000000oOM6D'
,'006C000000pHeYa'
,'006C000000nwsXx'
,'006C000000pGJM7'
,'006C000000pHnId'
,'006C000000oOgiD'
,'006C000000pH7yQ'
,'006C000000pHrjM'
,'006C000000pHNyZ'
,'006C000000oPe4f'
,'006C000000oPngd'
,'006C000000oOx4C'
,'006C000000oRJ0R'
,'006C000000oOJY1'
,'006C000000ny2sN'
,'006C000000ny2us')
